function doPost(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      return ContentService
        .createTextOutput("No postData received")
        .setMimeType(ContentService.MimeType.TEXT);
    }
    
    const ss = SpreadsheetApp.openById("1m84Ukd6CGo64CIB78HLmettJ2FugEVWKRexuDdCk_3Y");
    const sheet = ss.getSheetByName("Sheet1");
    
    // Get headers
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const body = JSON.parse(e.postData.contents);
    
    console.log('Received data:', body);
    
    const nameToEdit = body.__editName ? body.__editName.toString().trim() : null;
    let rowIndexToUpdate = -1;
    
    if (nameToEdit) {
      console.log('Looking for existing record:', nameToEdit);
      
      // Get all data to find existing record
      const lastRow = sheet.getLastRow();
      if (lastRow > 1) {
        const nameColumn = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
        
        for (let i = 0; i < nameColumn.length; i++) {
          const cellValue = nameColumn[i][0];
          if (cellValue && cellValue.toString().trim().toLowerCase() === nameToEdit.toLowerCase()) {
            rowIndexToUpdate = i + 2; // +2 because we start from row 2 and arrays are 0-indexed
            console.log('Found existing record at row:', rowIndexToUpdate);
            break;
          }
        }
      }
    }
    
    // Prepare row data based on headers
    const rowData = headers.map(header => {
      return body[header] !== undefined ? body[header] : '';
    });
    
    if (rowIndexToUpdate > -1) {
      // Update existing row
      sheet.getRange(rowIndexToUpdate, 1, 1, rowData.length).setValues([rowData]);
      console.log('Updated existing record at row:', rowIndexToUpdate);
      return ContentService
        .createTextOutput("Record Updated Successfully")
        .setMimeType(ContentService.MimeType.TEXT);
    } else {
      // Add new row
      sheet.appendRow(rowData);
      console.log('Added new record');
      return ContentService
        .createTextOutput("New Record Created Successfully")
        .setMimeType(ContentService.MimeType.TEXT);
    }
    
  } catch (error) {
    console.error('Error in doPost:', error);
    return ContentService
      .createTextOutput("Error: " + error.toString())
      .setMimeType(ContentService.MimeType.TEXT);
  }
}

function doGet() {
  try {
    const ss = SpreadsheetApp.openById("1m84Ukd6CGo64CIB78HLmettJ2FugEVWKRexuDdCk_3Y");
    const sheet = ss.getSheetByName("Sheet1");
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      // No data rows, return empty array
      return ContentService
        .createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const lastCol = sheet.getLastColumn();
    const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
    const data = sheet.getRange(2, 1, lastRow - 1, lastCol).getValues();
    
    const records = data.map(row => {
      let record = {};
      headers.forEach((header, index) => {
        record[header] = row[index] || '';
      });
      return record;
    });
    
    console.log('Returning', records.length, 'records');
    
    return ContentService
      .createTextOutput(JSON.stringify(records))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    console.error('Error in doGet:', error);
    return ContentService
      .createTextOutput(JSON.stringify({ error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
